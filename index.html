<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Flugtracker v1.7</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/togeojson@0.16.0"></script>
  <style>
    body { margin: 0; font-family: system-ui, sans-serif; background: #f0f2f5; }
    #banner { background: #002b4d; color: white; display: flex; align-items: center; padding: 6px 10px; font-size: 18px; }
    #banner img { height: 40px; margin-right: 12px; }
    #banner a { color: white; margin-left: auto; margin-right: 15px; font-size: 14px; text-decoration: none; }
    #layout { display: flex; height: calc(100vh - 60px); }
    #map { flex: 2; }
    #right { flex: 1; background: #fff; display: flex; flex-direction: column; padding: 10px; overflow-y: auto; }
    .controls { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
    .controls button, .controls select, .controls input {
      padding: 6px 10px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border: 1px solid #ccc; padding: 4px; font-size: 13px; }
    #footer { text-align: center; font-size: 12px; background: #002b4d; color: white; padding: 4px; }
  </style>
</head>
<body>
<div id="banner">
  <img src="logo.png" alt="Logo" />
  Flugtracker v1.7
  <a href="/log">ğŸ“„ Log</a>
  <a href="/stats">ğŸ“ˆ Statistiken</a>
</div>
<div id="layout">
  <div id="map"></div>
  <div id="right">
    <div class="controls">
      <button onclick="fetchFlights()">ğŸ”„ Aktualisieren</button>
      <button onclick="fetchOpenSky()">ğŸŒ OpenSky</button>
      <button onclick="location.href='/export.csv'">ğŸ“¥ CSV</button>
      <button onclick="location.href='/graphs1090'">ğŸ“Š Graphs</button>
      <button onclick="location.href='/tar1090'">ğŸ—ºï¸ tar1090</button>
    </div>
    <div class="controls">
      ğŸ“… von: <input type="date" id="fromDate" />
      ğŸ“… bis: <input type="date" id="toDate" />
      ğŸ“† <button onclick="setQuickDate(0)">Heute</button>
      <button onclick="setQuickDate(7)">7 Tage</button>
      <button onclick="setQuickDate(30)">30 Tage</button>
    </div>
    <div class="controls">
      âœˆï¸ Bewegungsart:
      <select id="movementType">
        <option value="all">alle</option>
        <option value="arrival">Anflug</option>
        <option value="departure">Abflug</option>
      </select>
      ğŸ“ Radius: <input type="number" id="radiusInput" value="5" min="1" max="20" style="width: 60px;">
      <button onclick="document.getElementById('radiusInput').value = 3">ğŸ“ Platzrunde</button>
    </div>
    <table id="flightTable">
      <thead><tr><th>Callsign</th><th>Typ</th><th>HÃ¶he</th><th>Speed</th><th>Zeit</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>
<div id="footer">â€“ Andreas Sika â€“</div>
<script>
let map = L.map('map').setView([48.2789, 8.4293], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap'
}).addTo(map);
let flightLayer = L.layerGroup().addTo(map);

function setQuickDate(days) {
  let now = new Date();
  let from = new Date();
  from.setDate(now.getDate() - days);
  document.getElementById("fromDate").valueAsDate = from;
  document.getElementById("toDate").valueAsDate = now;
}

function fetchFlights() {
  fetch('/flights.json')
    .then(r => r.json())
    .then(data => {
      let radiusLimit = parseFloat(document.getElementById("radiusInput").value) || 5;
      flightLayer.clearLayers();
      const tbody = document.querySelector('#flightTable tbody');
      tbody.innerHTML = '';
      data.forEach(f => {
        const dist = haversine(48.2789, 8.4293, f.lat, f.lon);
        if (dist > radiusLimit) return;
        const marker = L.circleMarker([f.lat, f.lon], {radius: 4, color: 'red'})
          .bindPopup(`<b>${f.callsign || ''}</b><br>${f.muster}<br>${f.baro_altitude} ft<br>${f.velocity || '-'} kt`);
        flightLayer.addLayer(marker);
        let row = tbody.insertRow();
        row.insertCell().textContent = f.callsign || '';
        row.insertCell().textContent = f.muster;
        row.insertCell().textContent = f.baro_altitude;
        row.insertCell().textContent = f.velocity || '-';
        row.insertCell().textContent = new Date(f.timestamp * 1000).toLocaleString();
      });
    });
}

function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371.0;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)) * 0.539957;
}

function fetchOpenSky() {
  fetch('/fetch-opensky').then(() => alert("OpenSky-Abfrage gestartet."));
}

function loadPlatzrunde() {
  fetch('/platzrunde.gpx')
    .then(res => res.text())
    .then(txt => new DOMParser().parseFromString(txt, "text/xml"))
    .then(data => {
      let geojson = toGeoJSON.gpx(data);
      L.geoJSON(geojson, {color: 'blue', dashArray: '4,4'}).addTo(map);
    });
}

fetchFlights();
loadPlatzrunde();
setInterval(fetchFlights, 60000);
</script>
</body>
</html>
