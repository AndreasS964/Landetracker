<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Flugtracker v1.7</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #map { height: 70%; }
    #controls { padding: 10px; background: #f0f0f0; }
    #footer {
      background: #ddd; font-size: 12px;
      text-align: center; padding: 4px;
    }
    button, select, input[type="date"] {
      margin: 3px;
      padding: 4px 8px;
    }
    table {
      width: 100%; border-collapse: collapse; margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc; padding: 4px; text-align: left;
    }
    th { background: #eee; cursor: pointer; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/togeojson@0.16.0"></script>
</head>
<body>
<div id="controls">
  <strong>Flugtracker v1.7</strong>
  <button onclick="fetchFlights()">ğŸ”„ Aktualisieren</button>
  <button onclick="fetchOpenSky()">ğŸŒ OpenSky</button>
  <button onclick="window.open('/export.csv')">ğŸ“¥ CSV Export</button>
  <button onclick="window.open('/graphs1090')">ğŸ“Š Graphs1090</button>
  <button onclick="window.open('/tar1090')">ğŸ—ºï¸ tar1090</button>
  <br>
  Filter: 
  <label>von: <input type="date" id="fromDate"></label>
  <label>bis: <input type="date" id="toDate"></label>
  <label>Art: 
    <select id="movementType">
      <option value="all">alle</option>
      <option value="arrival">Anflug</option>
      <option value="departure">Abflug</option>
    </select>
  </label>
</div>
<div id="map"></div>
<div id="tableWrap"><table id="flightTable"><thead><tr>
<th onclick="sortTable(0)">Callsign</th>
<th onclick="sortTable(1)">Typ</th>
<th onclick="sortTable(2)">HÃ¶he</th>
<th onclick="sortTable(3)">Zeit</th>
</tr></thead><tbody></tbody></table></div>
<div id="footer">â€“ Andreas Sika â€“</div>
<script>
let map = L.map('map').setView([48.2789, 8.4293], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 17, attribution: '&copy; OpenStreetMap'
}).addTo(map);
let flightLayer = L.layerGroup().addTo(map);

function fetchFlights() {
  fetch('/flights.json')
    .then(r => r.json())
    .then(data => {
      flightLayer.clearLayers();
      const tbody = document.querySelector('#flightTable tbody');
      tbody.innerHTML = '';
      data.forEach(f => {
        let m = L.circleMarker([f.lat, f.lon], {radius: 5, color: 'red'})
          .bindPopup(`<b>${f.callsign || 'n/a'}</b><br>${f.muster}<br>${f.baro_altitude} ft<br>${new Date(f.timestamp*1000).toLocaleTimeString()}`);
        flightLayer.addLayer(m);
        let row = tbody.insertRow();
        row.insertCell().textContent = f.callsign || '';
        row.insertCell().textContent = f.muster;
        row.insertCell().textContent = f.baro_altitude;
        row.insertCell().textContent = new Date(f.timestamp * 1000).toLocaleTimeString();
      });
    });
}

function fetchOpenSky() {
  fetch('/fetch-opensky').then(() => console.log("OpenSky fetch triggered"));
}

function loadPlatzrunde() {
  fetch('/platzrunde.gpx')
    .then(res => res.text())
    .then(str => new window.DOMParser().parseFromString(str, "text/xml"))
    .then(data => {
      let geojson = toGeoJSON.gpx(data);
      L.geoJSON(geojson, {
        color: 'blue',
        weight: 2,
        dashArray: '4,2'
      }).addTo(map);
    }).catch(e => console.warn("Platzrunde nicht verfÃ¼gbar", e));
}

function sortTable(n) {
  let table = document.getElementById("flightTable");
  let rows = Array.from(table.rows).slice(1);
  let asc = table.dataset.sortdir !== 'asc';
  rows.sort((a, b) => {
    return asc
      ? a.cells[n].innerText.localeCompare(b.cells[n].innerText)
      : b.cells[n].innerText.localeCompare(a.cells[n].innerText);
  });
  rows.forEach(row => table.tBodies[0].appendChild(row));
  table.dataset.sortdir = asc ? 'asc' : 'desc';
}

fetchFlights();
loadPlatzrunde();
setInterval(fetchFlights, 60000);
</script>
</body>
</html>