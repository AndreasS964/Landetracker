<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Flugtracker v1.9h</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  body { font-family: sans-serif; margin:0; padding:0; }
  #map { height: 400px; width: 100%; }
  .controls { padding: 10px; background: #f0f0f0; }
  .controls input, .controls select, .controls button { margin: 2px; }
  table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
  th, td { border: 1px solid #ccc; padding: 4px; text-align: left; }
  th { background: #eee; }
  footer { text-align:center; font-size:0.8em; color:#666; margin:10px; }
</style>
</head>
<body>
<div style="background:#333; color:white; padding:10px; display:flex; align-items:center; gap:10px;">
  <img src="flugtracker_logo_final.png" alt="Logo" height="60">
  <div style="font-size:1.2em;">ğŸ›©ï¸ FlugleiterÃ¼bersicht â€“ Landetracker v1.9h</div>
</div>
<div id="map"></div>
<div class="controls">
  Callsign: <input type="text" id="cs">
  HÃ¶he &le; <input type="number" id="max_alt" value="10000" style="width:70px;"> ft
  Radius: <input type="number" id="radius" value="5" style="width:50px;"> NM
  Von: <input type="date" id="from"> Bis: <input type="date" id="to">
  <select id="preset" onchange="setDateRange(this.value)">
    <option value="">â³ Zeitraum</option>
    <option value="1">Heute</option>
    <option value="2">Gestern</option>
    <option value="7">Letzte 7 Tage</option>
    <option value="30">Letzte 30 Tage</option>
  </select>
  <select id="movement">
    <option value="">ğŸš Bewegungsart</option>
    <option value="arrival">Anflug</option>
    <option value="departure">Abflug</option>
  </select>
  <button onclick="triggerRefresh()">ğŸš€ DB-Aktualisieren</button>
  <button onclick="update()">ğŸ”„ Anzeigen</button>
  <button onclick="exportCSV()">ğŸ“ CSV</button>
  <button onclick="alert('ğŸŒ OpenSky-Abruf folgt')">ğŸŒ OpenSky</button>
  <a href="/log">Log</a> |
  <a href="/stats">Statistiken</a> |
  <a href="http://localhost/tar1090">tar1090</a> |
  <a href="http://localhost/graphs1090">graphs1090</a>
</div>
<table id="flights-table"><thead><tr><th>Callsign</th><th>HÃ¶he</th><th>Speed</th><th>Lat</th><th>Lon</th><th>Zeit</th></tr></thead><tbody></tbody></table>
<footer>v1.9h â€“ Andreas Sika</footer>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map = L.map('map').setView([48.2788, 8.4293], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18
}).addTo(map);
let markers = [];

function update() {
  const from = document.getElementById('from').value;
  const to = document.getElementById('to').value;
  const cs = document.getElementById('cs').value.toLowerCase();
  const maxAlt = parseInt(document.getElementById('max_alt').value) || 10000;
  const radius = parseFloat(document.getElementById('radius').value) || 5;
  const move = document.getElementById('movement').value;
  fetch('/flights.json').then(r => r.json()).then(data => {
    markers.forEach(m => map.removeLayer(m));
    markers = [];
    let rows = '';
    data.filter(d => {
      if (cs && !d.cs.toLowerCase().includes(cs)) return false;
      if (d.alt > maxAlt) return false;
      if (move && d.mode !== move) return false;
      if (radius && haversine(d.lat, d.lon, 48.2788, 8.4293) > radius) return false;
      if (from && d.timestamp < new Date(from).getTime() / 1000) return false;
      if (to && d.timestamp > new Date(to).getTime() / 1000 + 86400) return false;
      return true;
    }).forEach(d => {
      L.circleMarker([d.lat, d.lon], {radius: 6}).addTo(map).bindPopup(d.cs);
      rows += `<tr><td>${d.cs}</td><td>${d.alt}</td><td>${d.vel}</td><td>${d.lat.toFixed(4)}</td><td>${d.lon.toFixed(4)}</td><td>${new Date(d.timestamp * 1000).toLocaleString()}</td></tr>`;
    });
    document.querySelector('#flights-table tbody').innerHTML = rows;
  });
}
function setDateRange(days) {
  if (!days) return;
  const to = new Date();
  const from = new Date();
  from.setDate(to.getDate() - parseInt(days));
  document.getElementById('from').valueAsDate = from;
  document.getElementById('to').valueAsDate = to;
}
function triggerRefresh() {
  fetch('/refresh-now').then(r => r.ok ? alert('âœ… DB aktualisiert') : alert('âŒ Fehler'));
}
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)) * 0.539957;
}
function exportCSV() {
  const rows = [['Callsign','Altitude','Speed','Lat','Lon','Time']];
  document.querySelectorAll('#flights-table tbody tr').forEach(tr => {
    const cols = [...tr.children].map(td => td.textContent);
    rows.push(cols);
  });
  const csv = rows.map(r => r.join(',')).join('\n');
  const blob = new Blob([csv], {type: 'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'flugtracker.csv';
  a.click();
}
</script>
</body>
</html>